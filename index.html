<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />

    <title>dgkf/R</title>
    <meta name="description" content="A reimagining of R"/>
    <meta name="application-name" content="R"/>
    <link rel="manifest" href="manifest.json"/>

    <meta name="viewport" content="viewport-fit=cover width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta name="theme-color" content="#111">
    <meta name="mobile-web-app-capable" content="yes"/> 
    <meta name="apply-mobile-web-app-title" content="R"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <!--
    <link rel="icon" type="image/svg+xml" size="any" href="TODO"/>
    <link rel="apple-touch-icon" type="image/png" sizes="1024x1024" href="TODO"/>
    <meta name="msapplication-TileColor" content="#111"/>
    <meta name="msapplication-TileImage" content="TODO"/>
    -->

   <style>
    html {
      scroll-behavior: smooth;
    }

    :root {
      --font-scale: 1;

      --dark-bg: rgb(0, 0, 0);
      --dark-fg: rgb(224, 224, 224);

      --light-bg: rgb(224, 224, 224);
      --light-fg: rgb(0, 0, 0);

      --bg: var(--dark-bg);
      --fg: var(--dark-fg);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: var(--light-bg);
        --fg: var(--light-fg);
      }      
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: var(--dark-bg);
        --fg: var(--dark-fg);
      }      
    }

    * {
      -webkit-transition: all 0.3s ease, font-size 0s linear;
      -moz-transition: all 0.3s ease, font-size 0s linear;
      -o-transition: all 0.3s ease, font-size 0s linear;
      -ms-transition: all 0.3s ease, font-size 0s linear;
      transition: all 0.3s ease, font-size 0s linear;
    }

    body {
      font-family: sans-serif, sans;
      padding: 0;
      margin: 0;
      background: color-mix(in lch, var(--bg) 90%, var(--fg));
      color: var(--fg);
    }

    pre {
      margin: 0.15rem;
      white-space: pre-wrap;
    }

    .container {
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0%;
      left: 1%;
      right: 1%;
      bottom: 0.5%;
    }

    .flex-row {
      display: flex;
      justify-content: space-between;
    }

    body, #prompt {
      font-size: calc(1rem * var(--font-scale));
    }

    @media only screen and (min-width: 768px) {
      .container {
        left: 10%;
        right: 10%;
        bottom: 10%;
      }
    }

    @media only screen and (min-width: 1200px) {
      .container {
        left: 20%;
        right: 20%;
        bottom: 20%;
      }
    }

    .history-scroll {
      height: 100%;
      overflow: scroll;
      scrollbar-width: none;
      scroll-behavior: smooth;
      -webkit-mask-image: -webkit-linear-gradient(bottom, rgba(0,0,0,1) max(10em, 30vh), rgba(0,0,0,0.2) max(20em, 60vh));
    }

    .history-scroll-pad {
      height: inherit;
    }

    .history-cell {
      color: var(--fg);
      padding: 0.25em 0.5em;
      border-radius: 0.5em;
      margin: 0.25em 0;
    }

    .input > pre:before {
      content: "> ";
    }

    .input, .output {
      background: color-mix(in lch, var(--bg) 85%, var(--fg));
    }

    .output {
      background: color-mix(in lch, var(--bg) 80%, var(--fg));
      color: color-mix(in lch, var(--bg) 20%, var(--fg));
    }

    .error {
      background: color-mix(in lch, #D11 25%, var(--bg));
      color: color-mix(in lch, #D11 25%, var(--fg));
    }

    .error a {
      color: color-mix(in lch, #D11 50%, var(--fg));
    }

    .btn {
      display: inline;
      border-radius: 0.5em;

      color: color-mix(in lch, var(--fg) 75%, var(--bg));
      font-size: 1.2em;
      font-weight: bold;

      padding: 0.2em 0.5em;
      margin: 0.2em 0 0 0;

      cursor: pointer;
      user-select: none;
    }

    .btn-group {
      display: flex;
      padding: 0.4em 0.5em 0;
    }

    .btn-slim {
      padding-left: 0;
      padding-right: 0;
    }

    .submit {
      background: #58F;
      color: white;
    }

    .submit:hover {
      background: #69F;
    }

    .submit:active {
      background: #7AF;
    }

    .clear {
      background: none;
    }

    .icon {
      font-size: 0.5em;
      padding: 0 1rem;
      vertical-align: middle;
      cursor: pointer;

      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: 50% 50%;
      mask-position: 50% 50%;

      background-color: color-mix(in lch, var(--fg) 75%, var(--bg));
    }

    .i-moon {
      -webkit-mask-image: url("assets/moon.svg");
      mask-image: url("assets/moon.svg");
    }

    .i-sun {
      -webkit-mask-image: url("assets/sun.svg");
      mask-image: url("assets/sun.svg");
    }

    .i-down-arrow {
      -webkit-mask-image: url("assets/down-arrow.svg");
      mask-image: url("assets/down-arrow.svg");
    }

    .i-up-arrow {
      -webkit-mask-image: url("assets/up-arrow.svg");
      mask-image: url("assets/up-arrow.svg");
    }

    .i-github {
      -webkit-mask-image: url("assets/github.svg");
      mask-image: url("assets/github.svg");
    }

    #prompt {
      box-sizing: border-box;
      font-family: monospace, mono;
      line-height: 1.5em;
      width: 100%;
      resize: vertical;

      background: var(--bg);
      color: var(--fg);

      border-radius: 1em;
      border: 0.2em solid color-mix(in lch, var(--bg), var(--fg));
      padding: 1em;
    }

    #prompt:focus {
      outline: 0;
      border-color: #555;
    }
    
   </style>
  </head>
  <body>
    <script type="module">
      import init, { wasm_session_header, wasm_env, wasm_parses_successfully } from "./pkg/r.js";
      window.r = await init().then(() => { 
        push("output", wasm_session_header());
        return {
          "eval": wasm_env(),
          "header": wasm_session_header,          
          "validate": wasm_parses_successfully,
        }
      });
    </script>

    <script>
      addEventListener("DOMContentLoaded", (event) => {
        let prompt = document.getElementById("prompt");
        prompt.addEventListener("keydown", prompt_input);
      });

      function prompt_input(event) {
        // possibly submit code
        if (event.key == "Enter") {
          // if ctrl is held
          if (event.ctrlKey || event.getModifierState("Meta")) {
            run();
            event.preventDefault();
            return;
          }

          // if code is a complete expression, run it
          let prompt = document.getElementById("prompt");
          let code = prompt.value;
          if (window.r.validate(code)) {
            run();
            event.preventDefault();
            return;
          }          
        }

        // add or remove lines based on input
        if (event.key == "Enter") {
          let prompt = document.getElementById("prompt");
          prompt.rows = prompt.value.split("\n").length + 1;
        }

        if (event.key == "Backspace") {
          let prompt = document.getElementById("prompt");
          let val = prompt.value;
          prompt.rows = val.substring(0, val.length - 1).split("\n").length;
        }
      }

      function push(type, content, elem) {
        let history = elem || document.getElementById("history");
        let node = document.createElement("div");
        let text = document.createElement("pre");
        node.className = "history-cell " + type;
        text.textContent = content;
        node.appendChild(text);
        history.appendChild(node);
        return node;
      }

      function unexpected_error(elem) {
        let history = elem || document.getElementById("history")
        let node = document.createElement("div");
        node.className = "history-cell error";

        var text = document.createElement("pre");
        text.textContent = "Error: An unexpected error was encountered!";
        node.appendChild(text);

        var text = document.createElement("span");
        text.textContent = "Why not ";
        node.appendChild(text);

        var link = document.createElement("a");
        link.href = "https://github.com/dgkf/R/issues";
        link.textContent = "submit an issue";
        node.appendChild(link);
        
        var text = document.createElement("span");
        text.textContent = "?";
        node.appendChild(text);

        history.appendChild(node);
        return node;
      }
      
      function run() {
        let prompt = document.getElementById("prompt");

        // read code and print to history
        let code = prompt.value;
        if (!code.trim()) { return clear_prompt(); }
        let input = push("input", code);
        
        // get result and print to history
        try { 
          let result = window.r.eval(code);
          let node = push("output", result, input);
          node.scrollIntoView();
        } catch (error) {
          console.log(error);
          let node = unexpected_error(input);
          node.scrollIntoView();
        }

        // clear prompt & restore focus
        clear_prompt();

        // // reset any resizing
        // prompt.rows = 1;
        // prompt.style = '';
      }

      function clear_prompt() {
        let prompt = document.getElementById("prompt");
        prompt.value = '';     
        prompt.rows = 1;
        prompt.focus();
      }

      function clear_history() {
        document.getElementById("history").innerHTML = '';
        push("output", window.r.header());
      }

      function font_size(value) {
        let root = document.querySelector(":root");
        root.style.setProperty("--font-scale", value);
      }

      function font_size_adjust(perc) {
        let root = document.querySelector(":root");
        let rootstyle = getComputedStyle(root);
        let scale = rootstyle.getPropertyValue("--font-scale");
        font_size(scale * perc)
      }

      function theme_light_icon() {
        return document.getElementById("light-mode");
      }

      function theme_dark_icon() {
        return document.getElementById("dark-mode");
      }

      function theme_light() {
        let root = document.querySelector(":root");
        root.style.setProperty("--bg", "var(--light-bg)")
        root.style.setProperty("--fg", "var(--light-fg)")

        theme_light_icon().style.display = "none";
        theme_dark_icon().style.display = "initial";
      }

      function theme_dark() {
        let root = document.querySelector(":root");
        root.style.setProperty("--bg", "var(--dark-bg)")
        root.style.setProperty("--fg", "var(--dark-fg)")

        theme_light_icon().style.display = "initial";
        theme_dark_icon().style.display = "none";
      }
    </script>

    <div class="background">
      <div class="container">
          <div class="history-scroll" id="history-scroll">
            <div class="history-scroll-pad"></div>
            <div class="history" id="history">
          </div>
        </div>
        <textarea id="prompt" name="prompt" cols="40" rows="1" 
          spellcheck="false" autocorrect="off" autocomplete="off" autocapitalize="none"
        >paste("Hello", "World!", sep = ", ")</textarea>
        <div class="flex-row">
          <div class="btn clear" onclick="clear_history()">clear</div>
          <div class = "btn-group">
            <div id="light-mode" class="icon i-sun" onclick="theme_light()" alt="switch to light mode"></div>
            <div id="dark-mode" class="icon i-moon" onclick="theme_dark()" alt="switch to dark mode" style="display: none;"></div>
          </div>
          <div class="btn-group">
            <a class="btn icon i-github" href="https://github.com/dgkf/R" target="_blank" alt="GitHub"></a>
          </div>
          <div class="btn-group">
            <div class="btn btn-slim icon i-down-arrow" onclick="font_size_adjust(8/9)" alt="decrease font size"></div>
            <div class="btn btn-slim font-reset" onclick="font_size(1)">Aa</div>
            <div class="btn btn-slim icon i-up-arrow" onclick="font_size_adjust(9/8)" alt="increase font size"></div>
          </div>
          <div class="btn submit" onclick="run()">run</div>
        </div>
      </div>
    </div>
  </body>
</html>
